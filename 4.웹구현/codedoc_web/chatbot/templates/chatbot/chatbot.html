{% extends 'base.html' %}
{% load static %}

{% block title %}AI 챗봇{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
{% endblock %}

{% block content %}
<div class="chat-page-container">
    <div id="chat-container">
        <div id="chat-window">
        </div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="메시지를 입력하세요...">
            <button id="send-button">전송</button>
        </div>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // 딜레이를 위한 Promise 기반 함수
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function sendMessage() {
        const query = messageInput.value.trim();
        if (query === '') return;

        addMessage(query, 'user');
        messageInput.value = '';

        await sleep(500); // 챗봇 말풍선이 나타나기 전 딜레이

        const botMessageElement = addMessage('', 'bot', true); // true for typing indicator

        let isFirstChunk = true;

        try {
            const response = await fetch('/chatbot/api/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            if (!response.ok) {
                throw new Error('서버에 문제가 발생했습니다.');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });

                if (isFirstChunk) {
                    botMessageElement.innerHTML = ''; // Clear typing indicator
                    isFirstChunk = false;
                }

                // 청크를 한 글자씩 타이핑 효과로 표시
                for (const char of chunk) {
                    botMessageElement.textContent += char;
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    await sleep(30); // 글자당 딜레이 (30ms)
                }
            }

        } catch (error) {
            console.error('Error:', error);
            botMessageElement.textContent = '죄송합니다, 답변을 가져오는 데 실패했습니다.';
        }
    }

    function addMessage(text, sender, showTypingIndicator = false) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
        
        if (showTypingIndicator) {
            messageElement.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        } else {
            messageElement.textContent = text;
        }

        chatWindow.appendChild(messageElement);
        // Force reflow to apply initial styles before transition
        messageElement.offsetHeight; 
        messageElement.style.opacity = 1;
        messageElement.style.transform = 'translateY(0)';
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageElement;
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // 페이지 로드 시 초기 메시지 추가
    window.addEventListener('load', () => {
        addMessage('안녕하세요! 금융 관련 질문을 해주시면 답변해 드립니다.', 'bot');
    });
</script>
{% endblock %}